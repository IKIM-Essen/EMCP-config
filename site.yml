#!/usr/bin/env ansible-playbook

# setup rancher on k1-20

---
- hosts: k8s
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  vars:
    ansible_ssh_private_key_file: files/ikimk8s_rsa
  environment: "{{ k8s_env | default({}) }}"
  roles:
    - update
    - docker
    - rancher
    - security


- hosts: infra
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - docker
    - security

- hosts: server
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - security


- hosts: cluster
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - update
    - c-nodes
    - nfs-client
    - singularity
    - security
    - ssh-config


- hosts: gpucluster
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - update
    - nfs-client
    - g-nodes
    - docker
    - security
    - nvidia
    - proxies
    - miniconda
    - ssh-config


- hosts: ipaserver
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  vars_files:
    - vars/secrets.yml
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - update
    - security
    - proxies
    - docker
    - ipaserver


- hosts: ipaclients
  become: yes
  ignore_errors: yes
  remote_user: ubuntu
  gather_facts: true
  vars_files:
    - vars/secrets.yml
  environment: "{{ proxy_env | default({}) }}"
  roles:
    - update
    - security
    - proxies
    - role: freeipa.ansible_freeipa.ipaclient
      state: present
      tags: freeIPA-client
