---
- name: Activate the option "always use nv"
  ansible.builtin.lineinfile:
    path: /etc/apptainer/apptainer.conf
    regexp: "^always use nv = no$"
    line: "always use nv = yes"
    owner: root
    group: root
    mode: 0644
    state: present

- name: Test GPU support as an unprivileged user
  ansible.builtin.shell: . /etc/profile.d/apptainer_env.sh && apptainer exec docker://nvcr.io/nvidia/cuda:12.0.0-base-ubuntu20.04 /usr/bin/nvidia-smi
  changed_when: false
  become: false
