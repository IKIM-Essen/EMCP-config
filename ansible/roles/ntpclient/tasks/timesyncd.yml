---
- name: Make sure that ntpd and chrony are uninstalled
  ansible.builtin.apt:
    name:
      - ntp
      - chrony
    state: absent

- name: Make sure that timesyncd is installed
  ansible.builtin.apt:
    name:
      - systemd-timesyncd
    state: present

# Since the packages ntp, chrony and systemd-timesyncd are mutually exclusive,
# if ntp or chrony are installed manually or as dependencies, they remove
# systemd-timesyncd and risk breaking the configuration. To prevent this,
# mark systemd-timesyncd as held.
- name: Prevent apt from automatically removing systemd-timesyncd
  ansible.builtin.command: apt-mark hold systemd-timesyncd
  register: cmd_apt_mark
  changed_when: cmd_apt_mark['stdout'] == 'systemd-timesyncd set on hold.'

- name: Enable and start the timesyncd service
  ansible.builtin.systemd:
    name: systemd-timesyncd
    state: started
    masked: false
    enabled: true

- name: Verify that timesyncd is configured correctly
  ansible.builtin.command: timedatectl show-timesync
  register: cmd_timedatectl
  changed_when: false
  failed_when: ('ServerAddress=' ~ ntp_server_ip) not in cmd_timedatectl['stdout_lines']
  become: false
