---
- name: Download the deb packages
  ansible.builtin.unarchive:
    src: "{{ slurm_worker_debs_url }}"
    dest: /tmp
    remote_src: true

- name: Install packages for pam_slurm_adopt
  ansible.builtin.apt:
    deb: "/tmp/{{ slurm_install_item }}"
    state: present
  loop:
    - "{{ slurm_worker_debs_dirname }}/libslurm37_{{ slurm_worker_debs_tag }}_amd64.deb"
    - "{{ slurm_worker_debs_dirname }}/libpam-slurm-adopt_{{ slurm_worker_debs_tag }}_amd64.deb"
  loop_control:
    loop_var: slurm_install_item

- name: Mask the systemd-logind service as instructed by the pam_slurm_adopt guide
  ansible.builtin.systemd:
    name: systemd-logind.service
    masked: true
    state: stopped

- name: Add a PAM profile for the pam_slurm_adopt module
  ansible.builtin.copy:
    src: pam-config-slurm
    dest: /usr/share/pam-configs/slurm
    owner: root
    group: root
    mode: "0644"

- name: Generate the PAM configuration
  ansible.builtin.command:
    argv:
      - pam-auth-update
      - --enable
      - slurm
      - --remove
      - systemd
  changed_when: true
