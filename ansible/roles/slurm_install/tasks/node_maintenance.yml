---
- name: Create the maintenance script root
  ansible.builtin.file:
    path: "{{ slurm_node_maintenance_script_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install the top-level shell script
  ansible.builtin.template:
    src: slurm_node_maintenance.sh.j2
    dest: "{{ slurm_node_maintenance_shell_script }}"
    owner: root
    group: root
    mode: "0755"

- name: Install the maintenance script
  ansible.builtin.copy:
    src: slurm_node_maintenance.py
    dest: "{{ slurm_node_maintenance_python_script }}"
    owner: root
    group: root
    mode: "0755"

- name: Install the systemd service for executing the shell script
  ansible.builtin.template:
    src: slurm-node-maintenance.service.j2
    dest: "/etc/systemd/system/{{ slurm_node_maintenance_systemd_unit_name }}.service"
    owner: root
    group: root
    mode: "0644"

- name: Install the corresponding timer unit
  ansible.builtin.template:
    src: slurm-node-maintenance.timer.j2
    dest: "/etc/systemd/system/{{ slurm_node_maintenance_systemd_unit_name }}.timer"
    owner: root
    group: root
    mode: "0644"
  notify: restart maintenance timer

- name: Enable and start the timer unit
  ansible.builtin.systemd:
    name: "{{ slurm_node_maintenance_systemd_unit_name }}.timer"
    state: started
    enabled: true
    daemon_reload: true
