---
- name: Before upgrading, remove the existing packages
  ansible.builtin.apt:
    name: "*slurm*"
    state: absent
  when: slurm_upgrade

- name: Configure apt to prefer the custom-built slurm packages
  ansible.builtin.copy:
    src: 99prefer-local-slurm
    dest: /etc/apt/preferences.d/99prefer-local-slurm
    owner: root
    group: root
    mode: "0644"

- name: Download the deb packages
  ansible.builtin.unarchive:
    src: "{{ slurm_worker_debs_url }}"
    dest: /tmp
    remote_src: true

- name: Install the worker daemon and client tools
  ansible.builtin.apt:
    deb: "/tmp/{{ slurm_install_item }}"
    state: present
  loop: "{{ slurm_worker_package_paths }}"
  loop_control:
    loop_var: slurm_install_item
