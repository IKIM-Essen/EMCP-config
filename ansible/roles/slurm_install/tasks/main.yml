---
- name: Obtain information for subsequent tasks
  become: true
  block:
    - ansible.builtin.include_tasks: facts.yml
  tags:
    - slurm
    - slurm-sssd
    - slurm-munge
    - slurm-node

# This needs testing to find out if it's necessary.
# See https://slurm.schedmd.com/faq.html#sssd
# - name: Enable enumeration in SSSD
#   become: true
#   block:
#     - ansible.builtin.include_tasks: sssd_enumerate.yml
#   tags:
#     - slurm
#     - slurm-sssd

- name: Install munge
  become: true
  block:
    - ansible.builtin.include_tasks: munge.yml
  tags:
    - slurm
    - slurm-munge

- name: Flush handlers to avoid missing restarts when subsequent tasks fail
  ansible.builtin.meta: flush_handlers
  tags:
    - slurm
    - slurm-munge

- name: Deploy worker nodes
  become: true
  block:
    - ansible.builtin.include_tasks: slurm_worker_install.yml
    - ansible.builtin.include_tasks: slurm_worker_configure.yml
    - ansible.builtin.include_tasks: slurm_worker_start.yml
  when: inventory_hostname in groups[slurm_worker_group_name]
  tags:
    - slurm
    - slurm-node
    - slurm-worker

- name: Deploy the controller node
  become: true
  block:
    - ansible.builtin.include_tasks: slurm_controller_install.yml
    - ansible.builtin.include_tasks: slurm_controller_configure.yml
    - ansible.builtin.include_tasks: slurm_controller_start.yml
  when: inventory_hostname in groups[slurm_controller_group_name]
  tags:
    - slurm
    - slurm-node
    - slurm-controller

- name: Deploy the database node
  become: true
  block:
    - ansible.builtin.include_tasks: slurm_dbd_install.yml
    - ansible.builtin.include_tasks: slurm_dbd_configure.yml
    - ansible.builtin.include_tasks: slurm_dbd_start.yml
  when: inventory_hostname in groups[slurm_dbd_group_name]
  tags:
    - slurm
    - slurm-node
    - slurm-dbd
