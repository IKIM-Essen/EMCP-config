
- name: install needed packages
  ansible.builtin.apt:
    name: open-iscsi
    state: present
  become: true

- name: add longhorn helm repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
  environment: "{{ proxy_env | default({}) }}"
  become: true

- name: install longhorn
  kubernetes.core.helm:
    release_name: longhorn
    release_namespace: longhorn-system
    chart_ref: longhorn/longhorn
    chart_version: "{{ longhorn_chart_version }}"
    kubeconfig: "/etc/rancher/kube_config_{{ rancher_cluster_config_name }}.yml"
    values:
      createDefaultDiskLabeledNodes: true
    wait: true
    release_state: present
  environment: "{{ proxy_env | default({}) }}"
  become: true