---
- name: Create the users listed in the ipausers dictionary
  community.general.ipa_user:
    ipa_host: "{{ primary_ipaserver }}"
    ipa_pass: "{{ ipaadmin_password }}"
    name: "{{ users_item['name'] }}"
    givenname: "{{ users_item['givenname'] | default('-') }}"
    sn: "{{ users_item['sn'] | default('-') }}"
    mail: "{{ users_item['email'] | default(omit) }}"
    loginshell: "{{ users_item['loginshell'] | default(omit) }}"
    sshpubkey: "{{ users_item['sshpubkey'] | default(omit) }}"
    validate_certs: false
    state: "{{ users_item['state'] }}"
  loop: "{{ ipausers }}"
  loop_control:
    loop_var: users_item

- name: Add the manager and expiration fields
  ansible.builtin.command:
    argv:
      - ipa
      - user-mod
      - "{{ users_item['name'] }}"
      - "--manager={{ users_item['manager'] | default('') }}"
      - "--principal-expiration={{ users_item['expiration'] | default('') }}"
  register: users_cmd_ipa
  changed_when: not (users_cmd_ipa['stderr'] | regex_search('no modifications to be performed'))
  failed_when:
    - users_cmd_ipa['rc'] != 0
    - not (users_cmd_ipa['stderr'] | regex_search('no modifications to be performed'))
  loop: "{{ ipausers }}"
  loop_control:
    loop_var: users_item
