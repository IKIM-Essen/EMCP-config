---
- name: Create service accounts listed in the ipasystemusers dictionary
  community.general.ipa_user:
    ipa_host: "{{ primary_ipaserver }}"
    ipa_pass: "{{ ipaadmin_password }}"
    name: "{{ users_item['name'] }}"
    givenname: "{{ users_item['givenname'] | default('-') }}"
    sn: "{{ users_item['sn'] | default('-') }}"
    mail: "{{ users_item['email'] | default([]) }}"
    loginshell: "{{ users_item['loginshell'] | default('/usr/sbin/nologin') }}"
    sshpubkey: "{{ users_item['sshpubkey'] | default([]) }}"
    validate_certs: false
    state: "{{ users_item['state'] | default('present') }}"
  loop: "{{ ipasystemusers }}"
  loop_control:
    loop_var: users_item

- name: Remove service accounts from the ipausers group
  ansible.builtin.command: "ipa group-remove-member ipausers --users={{ users_item['name'] }}"
  register: users_cmd_removemember
  changed_when: ('Number of members removed 1') in users_cmd_removemember['stdout_lines']
  failed_when:
    - users_cmd_removemember['rc'] != 0
    - ('This entry is not a member') not in users_cmd_removemember['stdout']
  loop: "{{ ipasystemusers }}"
  loop_control:
    loop_var: users_item
