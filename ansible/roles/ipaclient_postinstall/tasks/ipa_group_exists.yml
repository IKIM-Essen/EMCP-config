---
- name: check for krb5 package needed for kinit
  ansible.builtin.apt:
    name: krb5-user
    state: present

- name: Check whether a valid kerberos ticket is present
  ansible.builtin.command: klist -s
  changed_when: false
  failed_when: false
  register: cmd_klist

- name: Obtain a ticket using the default keytab on the current client
  ansible.builtin.command: kinit -k
  changed_when: true
  when:
    - cmd_klist['rc'] is defined
    - cmd_klist['rc'] != 0

- name: Query the server
  ansible.builtin.command: ipa group-find --group-name=docker
  changed_when: false
  failed_when: false
  register: cmd_group

- name: Save the query result as a true/false fact
  ansible.builtin.set_fact:
    docker_group_exists: "{{ cmd_group['rc'] == 0 }}"
  when: cmd_group['rc'] is defined
