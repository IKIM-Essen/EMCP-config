---
- name: Determine whether the slurm-build tag was specified
  ansible.builtin.set_fact:
    slurm_build: true
  tags:
    - never
    - slurm-build

- name: Display a message if the packaging task is being skipped
  ansible.builtin.debug:
    msg: The slurm packaging task is skipped by default. Add '--tags slurm-build' to enable it.
  when: slurm_build is not defined
  tags:
    - slurm

- name: Build slurm and create a package repository
  block:
    - ansible.builtin.include_tasks: slurm_repo_create.yml
      loop:
        - focal
        - jammy
      loop_control:
        loop_var: slurm_item
  when: inventory_hostname in groups[slurm_packager_group_name]
  tags:
    - never
    - slurm-build

- name: Configure the controller node
  become: true
  block:
    - ansible.builtin.include_tasks: facts.yml
    - ansible.builtin.include_tasks: sssd_enumerate.yml
    - ansible.builtin.include_tasks: munge.yml
    - ansible.builtin.include_tasks: slurm_install_controller.yml
    - ansible.builtin.include_tasks: slurm_configure.yml
    - ansible.builtin.include_tasks: slurm_start_controller.yml
  when: inventory_hostname in groups[slurm_controller_group_name]
  tags:
    - slurm
    - slurm-controller

- name: Configure worker nodes
  become: true
  block:
    - ansible.builtin.include_tasks: facts.yml
    - ansible.builtin.include_tasks: sssd_enumerate.yml
    - ansible.builtin.include_tasks: munge.yml
    - ansible.builtin.include_tasks: slurm_install_worker.yml
    - ansible.builtin.include_tasks: slurm_configure.yml
    - ansible.builtin.include_tasks: slurm_start_worker.yml
  when: inventory_hostname in groups[slurm_worker_group_name]
  tags:
    - slurm
    - slurm-worker
