---
- name: Install the prerequisites for using the "local" parameter in ansible.builtin.user
  ansible.builtin.apt:
    name: libuser
    state: present

- name: Add the user
  ansible.builtin.user:
    name: "{{ item['name'] }}"
    comment: "{{ item['comment'] | default(omit) }}"
    shell: "{{ item['shell'] | default(default_shell) }}"
    local: true
    state: present

- name: Make the user a sudoer
  ansible.builtin.template:
    src: sudoer.j2
    dest: "/etc/sudoers.d/01-user-{{ item['name'] }}"
    owner: root
    group: root
    mode: "0440"
    validate: /usr/sbin/visudo -cf %s

- name: Add the public key(s)
  ansible.posix.authorized_key:
    user: "{{ item['name'] }}"
    key: "{{ item['authorized_keys'] }}"
    state: present
  when: item['authorized_keys'] is defined
