# per https://www.tecmint.com/install-nfs-server-on-ubuntu/
# setup nfs client
# https://help.ubuntu.com/community/AutofsLDAP
# setup autofs

- name: install nfs client packages
  apt:
    name: nfs-common
    state: present
  tags:
    - nfs
    - autofs

- name: install cachefilesd
  apt:
    name: cachefilesd
    state: present
  tags:
    - cachefilesd
    - nfs
    - autofs

# use 2nd disk instead of system disk?
# might require either symlinking or other shenanigans
- name: config for cachefilesd
  copy:
    dest: /etc/cachefilesd.conf
    content: |
      # BEGIN ANSIBLE MANAGED BLOCK
      dir /local/cache/fscache
      secctx cachefiles_kernel_t
      brun 10%
      bcull 7%
      bstop 3%
      #secctx system_u:system_r:cachefiles_kernel_t:s0
      # END ANSIBLE MANAGED BLOCK
    owner: root
    group: root
    mode: 0644
  tags:
    - cachefilesd
    - nfs
    - autofs
  notify:
    - restart cachefilesd

- name: enable cachefilesd
  lineinfile:
    path: /etc/default/cachefilesd
    regexp: '#RUN=yes'
    line: 'RUN=yes'
  tags:
    - cachefilesd
    - nfs
    - autofs
  notify:
    - restart cachefilesd

# per https://help.ubuntu.com/community/AutofsLDAP
- name: install prerequisites
  apt:
    name:
      - autofs-ldap
      - ldap-utils
    state: present
  tags:
    - autofs

- name: configure ipa automount
  shell: ipa-client-automount -U
  become: true
  changed_when: false
  tags:
    - autofs
  notify:
    - restart autofs
