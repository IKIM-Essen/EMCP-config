- name: Install cachefilesd
  ansible.builtin.apt:
    name: cachefilesd
    state: present

- name: Make sure the cachefilesd service is running
  ansible.builtin.systemd:
    name: cachefilesd
    enabled: true
    state: started

- name: Create the cache directory
  ansible.builtin.file:
    path: "{{ cachefilesd_directory }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Configure the cache path
  ansible.builtin.lineinfile:
    path: /etc/cachefilesd.conf
    regexp: "^dir\\s"
    line: "dir {{ cachefilesd_directory }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart cachefilesd

- name: Tweak other cachefilesd settings
  ansible.builtin.lineinfile:
    path: /etc/cachefilesd.conf
    regexp: "^{{ nfs_client_item['name'] }}\\s"
    line: "{{ nfs_client_item['name'] }} {{ nfs_client_item['value'] }}"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ cachefilesd_options }}"
  loop_control:
    loop_var: nfs_client_item
  notify: restart cachefilesd

- name: Enable cachefilesd
  ansible.builtin.lineinfile:
    path: /etc/default/cachefilesd
    regexp: '^#?RUN='
    line: "RUN={{ 'yes' if cachefilesd_enabled else 'no' }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart cachefilesd
